# Million Requests per Second

With this project you'll be able to set up, with minor effort, an Erlang TCP server, any number of clients connecting to it, and monitor everything as it happens. This way you can introduce bottlenecks, bugs, or any other issue you want into the server and teach how to analyze the metrics/logs, debug, and resolve the issue.

## The Specification

### Server

- Handles client subscribe/unsubscribe.
- Broadcasts messages received from one client to the rest.


### Client

- Sends a message to the server every `N` seconds.
- Receives messages from the server (originally sent by another client).

### Monitor

- Monitoring of clients
- Monitoring of server

### Server-Client Interaction

Establishing a connection:
1. Client connects to server
1. Server responds with a banner `MRPS server 0.1`

Messages a client can send:
- `SEND<msg>`: The server sends `<msg>` to all the other clients connected. They receive the following: `Received message: <msg>`
- `COUNT`: the server responds with the amount of connected clients
- `EXIT`: Closes the connection to the server

## Requirements

- [Terraform 0.11.11](https://www.terraform.io/downloads.html)
- [Ansible 2.7.5](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installation-guide)
- Scaleway account (this can be changed to any other provider in Terraform configuration)

## Setup

Set the following environment variables:

- `TF_VAR_organization`: Your Scaleway organization ID
- `TF_VAR_token`: Your Scaleway API access token, generated by you
- `TF_VAR_ssh_key`: Your SSH key to access provisioned servers
- `TF_VAR_region`: (OPTIONAL) The Scaleway region, by default `par1`
- `TF_VAR_count`: (OPTIONAL) This is the amount of client servers to provision, by default 1

If you are using (or want) a different provider please check their corresponding documentation on how to setup for it at [Terraform Providers](https://www.terraform.io/docs/providers/index.html).

## Usage

### Creating the infrastructure

```
$> make infra
```

This will provision your servers using the Terraform configuration. You will be asked to confirm if you want to perform the actions, type `yes` to confirm.

```
Plan: 8 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

Terraform will output the IPs of the provisioned servers:

```
Outputs:

client_ips = [
    192.168.1.208
]
server_ip = 192.168.1.100

monitor_ip = 192.168.1.133
```

### Preparing the servers

Install everything you need and setup your clients, server, and monitoring by doing:

```
$> make ops
```

### Trying it out

```
$> make run
```

This will run Tsung using [its configuration](devops/templates/tsung.xml.j2).
